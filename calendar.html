<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dentist Weekly Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .time-slot {
      height: 50px;
      vertical-align: middle;
      text-align: center;
    }
    .booked {
      background-color: #ffd6d6;
      font-weight: bold;
    }
    thead th {
      text-align: center;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">Dentist Weekly Appointment Calendar</h2>

    <!-- Week selector -->
    <div class="mb-3 text-center">
      <label for="weekPicker" class="form-label fw-bold">Select a week:</label>
      <input type="date" id="weekPicker" class="form-control w-auto d-inline-block"
             min="2025-07-07" max="2026-07-07" value="2025-07-07"/>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Time</th>
            <th>Monday<br><small class="date-label"></small></th>
            <th>Tuesday<br><small class="date-label"></small></th>
            <th>Wednesday<br><small class="date-label"></small></th>
            <th>Thursday<br><small class="date-label"></small></th>
            <th>Friday<br><small class="date-label"></small></th>
          </tr>
        </thead>
        <tbody id="calendarBody">
          <!-- Dynamically filled -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const dateInput = document.getElementById('weekPicker');
    const dateLabels = document.querySelectorAll('.date-label');
    const calendarBody = document.getElementById('calendarBody');

    const times = [
      "9:00 AM", "9:30 AM", "10:00 AM", "10:30 AM",
      "11:00 AM", "11:30 AM", "12:00 PM", "12:30 PM",
      "1:00 PM", "1:30 PM", "2:00 PM", "2:30 PM",
      "3:00 PM", "3:30 PM", "4:00 PM", "4:30 PM"
    ];

    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day + 6) % 7; // Adjust so Monday is start
      d.setDate(d.getDate() - diff);
      return d;
    }

    function updateWeekDatesAndCalendar(startDateStr) {
      const monday = getMonday(startDateStr);
      const weekDates = [];

      // Update header labels
      for (let i = 0; i < 5; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        dateLabels[i].textContent = d.toLocaleDateString('en-CA');
        weekDates.push(d.toISOString().split('T')[0]); // Format YYYY-MM-DD
      }

      // Clear previous rows
      calendarBody.innerHTML = "";

      // Populate time slots
      times.forEach(time => {
        const row = document.createElement("tr");
        row.innerHTML = `<td class="time-slot">${time}</td>` + weekDates.map(() => `<td>â€”</td>`).join("");
        calendarBody.appendChild(row);
      });

      // Fetch and fill booked slots from backend
      fetchAppointments(weekDates);
    }

    async function fetchAppointments(weekDates) {
      try {
        const response = await fetch(`http://127.0.0.1:8000/api/appointments?dates=${weekDates.join(",")}`);
        const data = await response.json();

        // Fill the table
        const rows = calendarBody.querySelectorAll("tr");
        for (const appt of data) {
          const timeIndex = times.indexOf(appt.time);
          const dayIndex = weekDates.indexOf(appt.date); // Monday = 0
          if (timeIndex !== -1 && dayIndex !== -1) {
            const cell = rows[timeIndex].children[dayIndex + 1]; // +1 offset due to time slot in first column
            cell.classList.add("booked");
            cell.textContent = appt.name;
          }
        }
      } catch (error) {
        console.error("Failed to load appointments:", error);
      }
    }

    // Initial load
    updateWeekDatesAndCalendar(dateInput.value);
    dateInput.addEventListener('change', () => {
      updateWeekDatesAndCalendar(dateInput.value);
    });
  </script>
</body>
</html>
