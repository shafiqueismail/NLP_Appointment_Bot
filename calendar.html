<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dentist Weekly Calendar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .time-slot {
      height: 50px;
      vertical-align: middle;
      text-align: center;
    }
    .booked {
      background-color: #ffd6d6;
      font-weight: bold;
    }
    .highlight-today {
      background-color: #ffe0b3 !important;
    }
    thead th {
      text-align: center;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="text-center mb-4">Dentist Weekly Appointment Calendar</h2>

    <!-- Week navigation -->
    <div class="mb-3 text-center">
      <button id="prevWeek" class="btn btn-outline-primary me-2">Previous Week</button>
      <input type="date" id="weekPicker" class="form-control d-inline-block w-auto"
             min="2025-07-07" max="2026-07-07"/>
      <button id="nextWeek" class="btn btn-outline-primary ms-2">Next Week</button>
    </div>

    <!-- Calendar table -->
    <div class="table-responsive">
      <table class="table table-bordered">
        <thead class="table-light">
          <tr id="calendarHeader">
            <!-- Filled dynamically -->
          </tr>
        </thead>
        <tbody id="calendarBody">
          <!-- Filled dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const dateInput = document.getElementById('weekPicker');
    const prevBtn = document.getElementById('prevWeek');
    const nextBtn = document.getElementById('nextWeek');
    const calendarHeader = document.getElementById('calendarHeader');
    const calendarBody = document.getElementById('calendarBody');

    const times = [
      "9:00 AM", "9:30 AM", "10:00 AM", "10:30 AM",
      "11:00 AM", "11:30 AM", "12:00 PM", "12:30 PM",
      "1:00 PM", "1:30 PM", "2:00 PM", "2:30 PM",
      "3:00 PM", "3:30 PM", "4:00 PM", "4:30 PM"
    ];

    const dayNames = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1 - day); // Sunday = 0 → back to Monday
      d.setDate(d.getDate() + diff);
      return d;
    }

    function updateWeekDatesAndCalendar(startDateStr) {
      const monday = getMonday(startDateStr);
      const todayUS = new Date().toLocaleString("en-US", { timeZone: "America/New_York" });
      const todayStr = new Date(todayUS).toISOString().split("T")[0];
      const weekDates = [];

      // Update header
      let headerHTML = `<th>Time</th>`;
      for (let i = 0; i < 7; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        const iso = d.toISOString().split("T")[0];
        weekDates.push(iso);
        headerHTML += `<th>${dayNames[i]}<br><small class="date-label">${d.toLocaleDateString("en-CA")}</small></th>`;
      }
      calendarHeader.innerHTML = headerHTML;

      // Update date picker to reflect current Monday
      const mondayISO = monday.toISOString().split("T")[0];
      dateInput.value = mondayISO;

      // Clear table
      calendarBody.innerHTML = "";

      // Fill table
      times.forEach(time => {
        const row = document.createElement("tr");
        let rowHTML = `<td class="time-slot">${time}</td>`;

        weekDates.forEach(date => {
          const isToday = (date === todayStr);
          const tdClass = isToday ? 'highlight-today' : '';
          rowHTML += `<td class="${tdClass}">—</td>`;
        });

        row.innerHTML = rowHTML;
        calendarBody.appendChild(row);
      });

      fetchAppointments(weekDates);
    }

    async function fetchAppointments(weekDates) {
      try {
        const response = await fetch(`http://127.0.0.1:8000/api/appointments?dates=${weekDates.join(",")}`);
        const data = await response.json();

        const rows = calendarBody.querySelectorAll("tr");
        for (const appt of data) {
          const timeIndex = times.indexOf(appt.time);
          const dayIndex = weekDates.indexOf(appt.date);
          if (timeIndex !== -1 && dayIndex !== -1) {
            const cell = rows[timeIndex].children[dayIndex + 1];
            cell.classList.add("booked");
            cell.textContent = appt.name;
          }
        }
      } catch (error) {
        console.error("Failed to load appointments:", error);
      }
    }

    // Button actions
    prevBtn.addEventListener('click', () => {
      const d = new Date(dateInput.value);
      d.setDate(d.getDate() - 7);
      dateInput.value = d.toISOString().split("T")[0];
      updateWeekDatesAndCalendar(dateInput.value);
    });

    nextBtn.addEventListener('click', () => {
      const d = new Date(dateInput.value);
      d.setDate(d.getDate() + 7);
      dateInput.value = d.toISOString().split("T")[0];
      updateWeekDatesAndCalendar(dateInput.value);
    });

    dateInput.addEventListener('change', () => {
      updateWeekDatesAndCalendar(dateInput.value);
    });

    // Initialize with today (Eastern time)
    const todayUS = new Date().toLocaleString("en-US", { timeZone: "America/New_York" });
    const todayDate = new Date(todayUS).toISOString().split("T")[0];
    dateInput.value = todayDate;
    updateWeekDatesAndCalendar(todayDate);
  </script>
</body>
</html>
